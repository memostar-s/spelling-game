<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Spelling Practice</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg-deep:    #0f172a;
    --bg-card:    rgba(30, 41, 59, 0.75);
    --bg-input:   #0f172a;
    --border:     #334155;
    --border-mid: #475569;
    --text-main:  #f1f5f9;
    --text-sub:   #94a3b8;
    --text-dim:   #64748b;
    --blue:       #3b82f6;
    --blue-glow:  rgba(59,130,246,0.2);
    --green:      #10b981;
    --green-glow: rgba(16,185,129,0.15);
    --purple:     #8b5cf6;
    --amber:      #f59e0b;
    --red:        #ef4444;
  }

  html, body {
    min-height: 100%; height: 100%;
    background: linear-gradient(145deg, var(--bg-deep) 0%, #1e1b4b 50%, var(--bg-deep) 100%);
    color: var(--text-main);
    font-family: 'Georgia', 'Times New Roman', serif;
    -webkit-tap-highlight-color: transparent;
    overflow-x: hidden;
  }

  /* â”€â”€â”€ Blobs â”€â”€â”€ */
  .blob { position: fixed; border-radius: 50%; pointer-events: none; z-index: 0; }
  .blob-1 { top:-140px; left:-140px; width:380px; height:380px; background:radial-gradient(circle,rgba(59,130,246,0.13),transparent 70%); }
  .blob-2 { bottom:-120px; right:-120px; width:340px; height:340px; background:radial-gradient(circle,rgba(139,92,246,0.11),transparent 70%); }

  /* â”€â”€â”€ Layout â”€â”€â”€ */
  .wrapper { position:relative; z-index:1; max-width:640px; margin:0 auto; padding:20px 18px 40px; min-height:100vh; display:flex; flex-direction:column; }

  /* â”€â”€â”€ Header â”€â”€â”€ */
  .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:22px; }
  .header h1 { font-size:18px; font-weight:600; letter-spacing:0.5px; color:var(--text-main); }
  .header-back {
    display:flex; align-items:center; gap:6px;
    background:none; border:none; color:var(--text-sub); font-size:14px;
    cursor:pointer; font-family:inherit; padding:6px 0; transition:color 0.2s;
  }
  .header-back:hover { color:var(--blue); }

  /* â”€â”€â”€ Folder Grid â”€â”€â”€ */
  .folder-grid { display:flex; flex-direction:column; gap:10px; flex:1; }
  .folder-card {
    display:flex; align-items:center; gap:14px;
    padding:16px 18px; border-radius:14px;
    background:var(--bg-card); border:1px solid var(--border);
    cursor:pointer; transition:border-color 0.2s, background 0.2s;
    text-decoration:none;
  }
  .folder-card:hover { border-color:var(--blue); background:rgba(30,41,59,0.9); }
  .folder-icon {
    font-size:26px; width:44px; height:44px;
    display:flex; align-items:center; justify-content:center;
    border-radius:10px; background:rgba(59,130,246,0.1);
    border:1px solid rgba(59,130,246,0.25); flex-shrink:0;
  }
  .folder-info { flex:1; min-width:0; }
  .folder-name { font-size:16px; font-weight:600; color:var(--text-main); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .folder-count { font-size:12px; color:var(--text-dim); margin-top:2px; }
  .folder-actions { display:flex; gap:4px; flex-shrink:0; }
  .folder-btn {
    width:32px; height:32px; border-radius:7px; border:1px solid var(--border);
    background:rgba(30,41,59,0.5); color:var(--text-dim);
    font-size:15px; cursor:pointer; display:flex; align-items:center; justify-content:center;
    transition:border-color 0.2s, color 0.2s, background 0.2s;
  }
  .folder-btn:hover { border-color:var(--border-mid); color:var(--text-sub); background:rgba(30,41,59,0.8); }
  .folder-btn.del:hover { border-color:var(--red); color:var(--red); }
  .folder-btn.ok:hover { border-color:var(--green); color:var(--green); }
  .folder-card.renaming { cursor:default; }
  .rename-input {
    width:100%; padding:4px 8px; border-radius:6px;
    border:1px solid var(--blue); background:var(--bg-input);
    color:var(--text-main); font-size:15px; font-weight:600;
    font-family:inherit; outline:none;
  }

  /* â”€â”€â”€ Add Folder â”€â”€â”€ */
  .add-folder-row { display:flex; gap:8px; margin-bottom:18px; }
  .add-folder-row input {
    flex:1; padding:10px 14px; border-radius:10px; border:1px solid var(--border-mid);
    background:var(--bg-input); color:var(--text-main); font-size:14px;
    font-family:inherit; outline:none; transition:border-color 0.2s;
  }
  .add-folder-row input:focus { border-color:var(--blue); }
  .add-folder-row input::placeholder { color:var(--text-dim); }
  .btn-add-folder {
    padding:10px 18px; border-radius:10px; border:none;
    background:linear-gradient(135deg,var(--blue),var(--purple)); color:#fff;
    font-size:14px; font-weight:600; cursor:pointer; font-family:inherit;
    white-space:nowrap; transition:opacity 0.2s;
  }
  .btn-add-folder:hover { opacity:0.85; }

  /* â”€â”€â”€ Word Manager (inside a folder) â”€â”€â”€ */
  .wm-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; flex-wrap:wrap; gap:8px; }
  .wm-title { font-size:17px; font-weight:600; color:var(--text-main); }
  .wm-actions { display:flex; gap:8px; }

  .wm-add-row { display:flex; gap:7px; margin-bottom:16px; }
  .wm-add-row input {
    flex:1; min-width:0; padding:10px 13px; border-radius:9px; border:1px solid var(--border-mid);
    background:var(--bg-input); color:var(--text-main); font-size:14px;
    font-family:inherit; outline:none; transition:border-color 0.2s;
  }
  .wm-add-row input:focus { border-color:var(--blue); }
  .wm-add-row input::placeholder { color:var(--text-dim); }
  .btn-add-word {
    padding:10px 16px; border-radius:9px; border:none;
    background:var(--green); color:#fff; font-size:20px; font-weight:700;
    cursor:pointer; transition:background 0.2s; flex-shrink:0;
  }
  .btn-add-word:hover { background:#059669; }

  /* select-all row */
  .select-all-row {
    display:flex; align-items:center; gap:9px;
    padding:8px 13px; border-radius:9px;
    background:rgba(59,130,246,0.07); border:1px solid rgba(59,130,246,0.2);
    margin-bottom:10px; cursor:pointer; user-select:none;
  }
  .select-all-row:hover { background:rgba(59,130,246,0.12); }
  .select-all-row span { color:#60a5fa; font-size:13px; font-weight:600; }

  .word-list { display:flex; flex-direction:column; gap:6px; margin-bottom:18px; max-height:340px; overflow-y:auto; padding-right:2px; }
  .word-item {
    display:flex; align-items:center; gap:10px;
    padding:10px 13px; border-radius:9px;
    background:var(--bg-input); border:1px solid var(--border);
    transition:border-color 0.2s;
  }
  .word-item.selected { border-color:rgba(59,130,246,0.4); background:rgba(59,130,246,0.06); }
  .word-item .wi-check {
    width:20px; height:20px; border-radius:5px; border:2px solid var(--border-mid);
    background:transparent; flex-shrink:0; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    transition:border-color 0.2s, background 0.2s;
  }
  .word-item.selected .wi-check { border-color:var(--blue); background:var(--blue); }
  .word-item .wi-check::after { content:""; display:none; width:6px; height:10px; border:solid #fff; border-width:0 2px 2px 0; transform:rotate(45deg); margin-bottom:2px; }
  .word-item.selected .wi-check::after { display:block; }
  .word-item .wi-text { flex:1; min-width:0; }
  .word-item .wi-word { color:#60a5fa; font-weight:700; font-size:15px; }
  .word-item .wi-meaning { color:var(--text-dim); font-size:13px; margin-left:8px; }
  .word-item .wi-del {
    background:none; border:none; color:var(--text-dim); font-size:16px;
    cursor:pointer; transition:color 0.2s; padding:2px 5px; flex-shrink:0;
  }
  .word-item .wi-del:hover { color:var(--red); }

  .wm-footer { display:flex; justify-content:space-between; align-items:center; margin-top:4px; }
  .wm-selected-info { font-size:12px; color:var(--text-dim); }
  .wm-selected-info span { color:var(--blue); font-weight:600; }
  .btn-start-test {
    padding:10px 28px; border-radius:10px; border:none;
    background:linear-gradient(135deg,var(--blue),var(--purple)); color:#fff;
    font-size:15px; font-weight:600; cursor:pointer; font-family:inherit;
    transition:opacity 0.2s;
  }
  .btn-start-test:hover { opacity:0.85; }
  .btn-start-test:disabled { opacity:0.35; cursor:default; }

  /* â”€â”€â”€ Quiz Screen â”€â”€â”€ */
  .progress-header { display:flex; justify-content:space-between; font-size:12px; color:var(--text-dim); margin-bottom:6px; }
  .progress-bar-bg { height:4px; border-radius:2px; background:#1e293b; margin-bottom:22px; }
  .progress-bar-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--blue),var(--purple)); width:0%; transition:width 0.4s ease; }

  .card {
    background:var(--bg-card); border:1px solid var(--border); border-radius:22px;
    padding:34px 24px 30px; backdrop-filter:blur(8px);
    box-shadow:0 20px 60px rgba(0,0,0,0.3);
    flex:1; display:flex; flex-direction:column; align-items:center;
  }
  .meaning-badge {
    display:inline-block; padding:6px 20px; border-radius:20px;
    background:rgba(59,130,246,0.15); border:1px solid rgba(59,130,246,0.3);
    color:#60a5fa; font-size:20px; font-weight:600; margin-bottom:6px;
  }
  .letters-row { display:flex; justify-content:center; align-items:flex-end; gap:5px; flex-wrap:wrap; padding:22px 0 10px; }
  .letter-box {
    width:42px; height:54px; border-radius:10px;
    display:flex; align-items:center; justify-content:center; position:relative;
    background:var(--bg-input); border:2px solid var(--border);
    transition:background 0.2s, border-color 0.2s, box-shadow 0.2s;
  }
  .letter-box span { font-size:21px; font-weight:700; color:var(--text-main); text-transform:lowercase; transition:color 0.2s; }
  .letter-box .underline { position:absolute; bottom:6px; left:15%; right:15%; height:2px; background:var(--border-mid); border-radius:1px; }
  .letter-box.space {
    width:14px; height:54px; min-width:14px;
    background:transparent; border:none; box-shadow:none;
    border-radius:0; align-self:flex-end;
  }
  .letter-box.space .underline { display:none; }
  .letter-box.revealed span { color:#60a5fa; }
  .letter-box.filled { background:rgba(16,185,129,0.12); border-color:var(--green); box-shadow:0 0 12px var(--green-glow); }
  .letter-box.filled span { color:#34d399; }
  .letter-box.wrong { background:rgba(239,68,68,0.1); border-color:var(--red); }

  .msg { width:100%; border-radius:12px; padding:12px 20px; text-align:center; font-size:15px; font-weight:600; margin-top:10px; margin-bottom:4px; }
  .msg-correct { background:rgba(16,185,129,0.12); border:1px solid rgba(16,185,129,0.3); color:#34d399; }
  .msg-warning { background:transparent; border:none; color:var(--amber); font-size:13px; font-weight:400; margin-top:6px; }

  .btn-row { display:flex; justify-content:center; gap:10px; margin-top:18px; flex-wrap:wrap; }
  .btn {
    padding:11px 24px; border-radius:10px; font-size:14px; font-weight:600;
    font-family:inherit; cursor:pointer; border:none;
    transition:opacity 0.2s, transform 0.1s; -webkit-tap-highlight-color:transparent;
  }
  .btn:active { transform:scale(0.95); }
  .btn-hint { background:rgba(245,158,11,0.1); border:1px solid var(--amber); color:var(--amber); }
  .btn-hint:hover { background:rgba(245,158,11,0.18); }
  .btn-hint:disabled { background:rgba(30,41,59,0.4); border-color:var(--border); color:var(--border-mid); cursor:default; }
  .btn-skip { background:rgba(30,41,59,0.4); border:1px solid var(--border-mid); color:var(--text-sub); }
  .btn-skip:hover { border-color:var(--text-sub); }
  .btn-next { background:linear-gradient(135deg,var(--blue),var(--purple)); color:#fff; font-size:16px; padding:12px 38px; }

  .instructions { margin-top:22px; padding:14px 18px; border-radius:12px; background:rgba(30,41,59,0.4); border:1px solid #1e293b; text-align:center; }
  .instructions p { color:var(--text-dim); font-size:12.5px; line-height:1.8; margin:0; }

  /* â”€â”€â”€ Virtual Keyboard â”€â”€â”€ */
  .vkb { display:none; }
  @media (max-width:600px) { .vkb { display:flex; flex-direction:column; gap:6px; margin-top:20px; } }
  .vkb-row { display:flex; justify-content:center; gap:5px; flex-wrap:wrap; }
  .vkb-key {
    width:32px; height:42px; border-radius:7px;
    display:flex; align-items:center; justify-content:center;
    background:rgba(30,41,59,0.7); border:1px solid var(--border);
    color:var(--text-main); font-size:15px; font-weight:600;
    cursor:pointer; user-select:none; -webkit-tap-highlight-color:transparent;
    transition:background 0.15s, transform 0.1s; font-family:inherit;
  }
  .vkb-key:active { background:rgba(59,130,246,0.35); transform:scale(0.9); }
  .vkb-key.backspace { width:52px; font-size:18px; color:var(--amber); border-color:rgba(245,158,11,0.3); }
  .vkb-key.backspace:active { background:rgba(245,158,11,0.2); }
  .vkb-key.vkb-space { width:180px; font-size:13px; color:var(--text-sub); letter-spacing:1px; border-color:var(--border-mid); }
  .vkb-key.vkb-space:active { background:rgba(139,92,246,0.3); }

  /* â”€â”€â”€ End Screen â”€â”€â”€ */
  .end-screen { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px 0; }
  .end-emoji { font-size:58px; margin-bottom:14px; }
  .end-screen h2 { font-size:26px; margin-bottom:6px; }
  .end-pct { color:#60a5fa; font-size:34px; font-weight:700; }
  .end-stats { display:flex; gap:40px; margin:18px 0 28px; }
  .end-stat-val { font-size:26px; font-weight:700; }
  .end-stat-label { font-size:12px; color:var(--text-dim); margin-top:2px; }
  .btn-restart { background:linear-gradient(135deg,var(--blue),var(--purple)); color:#fff; padding:12px 32px; border-radius:12px; border:none; font-size:15px; font-weight:600; cursor:pointer; font-family:inherit; }
  .end-btn-row { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
  .btn-back-home { background:rgba(30,41,59,0.6); border:1px solid var(--border-mid); color:var(--text-sub); padding:12px 24px; border-radius:12px; font-size:15px; font-weight:600; cursor:pointer; font-family:inherit; }

  /* â”€â”€â”€ Confetti â”€â”€â”€ */
  .confetti-wrap { position:fixed; inset:0; pointer-events:none; z-index:50; }
  .confetti-piece { position:absolute; top:-24px; animation:confettiFall 2.1s ease-in forwards; }
  @keyframes confettiFall { 0%{transform:translateY(0) rotate(0deg);opacity:1} 100%{transform:translateY(105vh) rotate(780deg);opacity:0} }

  /* â”€â”€â”€ Responsive â”€â”€â”€ */
  @media (max-width:420px) {
    .letter-box { width:34px; height:46px; border-radius:8px; }
    .letter-box span { font-size:18px; }
    .meaning-badge { font-size:18px; padding:5px 16px; }
    .card { padding:26px 16px 24px; border-radius:18px; }
    .vkb-key { width:29px; height:39px; font-size:14px; }
    .vkb-key.backspace { width:46px; }
  }

  /* â”€â”€â”€ Scrollbar â”€â”€â”€ */
  .word-list::-webkit-scrollbar { width:5px; }
  .word-list::-webkit-scrollbar-track { background:transparent; }
  .word-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
</style>
</head>
<body>

<div class="blob blob-1"></div>
<div class="blob blob-2"></div>
<div class="confetti-wrap" id="confetti"></div>
<div class="wrapper" id="app"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA & STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = "spelling-tool-v3";

const DEFAULT_DATA = {
  folders: [
    {
      id: "default-L1",
      name: "åœ‹ä¸€ä¸‹ L1",
      words: [
        {word:"like",meaning:"å–œæ­¡ï¼›åƒ",selected:false},
        {word:"sport",meaning:"é‹å‹•",selected:false},
        {word:"much",meaning:"å¤šï¼ˆçš„ï¼‰",selected:false},
        {word:"team",meaning:"éšŠï¼›çµ„",selected:false},
        {word:"practice",meaning:"ç·´ç¿’",selected:false},
        {word:"every",meaning:"æ¯ä¸€",selected:false},
        {word:"then",meaning:"é‚£éº¼",selected:false},
        {word:"swim",meaning:"æ¸¸æ³³",selected:false},
        {word:"join",meaning:"åƒåŠ ",selected:false},
        {word:"eye",meaning:"çœ¼ç›",selected:false},
        {word:"hair",meaning:"é ­é«®",selected:false},
        {word:"know",meaning:"çŸ¥é“ï¼›èªè­˜",selected:false},
        {word:"hundred",meaning:"ç™¾",selected:false},
        {word:"centimeter",meaning:"å…¬åˆ†ï¼ˆcmï¼‰",selected:false},
        {word:"You can say that again",meaning:"ä¸€é»ä¹Ÿæ²’éŒ¯ï¼",selected:false},
        {word:"guitar",meaning:"å‰ä»–",selected:false},
        {word:"piano",meaning:"é‹¼ç´",selected:false},
        {word:"fly a kite",meaning:"æ”¾é¢¨ç®",selected:false},
        {word:"paint",meaning:"ç•«åœ–ï¼›é¡æ–™ï¼›æ²¹æ¼†",selected:false},
        {word:"make a cake",meaning:"åšè›‹ç³•",selected:false},
        {word:"nose",meaning:"é¼»å­",selected:false},
        {word:"leg",meaning:"è…¿",selected:false},
        {word:"large",meaning:"å¤§çš„",selected:false},
        {word:"ear",meaning:"è€³æœµ",selected:false},
        {word:"mouth",meaning:"å˜´å·´",selected:false},
        {word:"thick",meaning:"åšçš„",selected:false},
        {word:"lip",meaning:"å˜´å”‡",selected:false},
        {word:"strong",meaning:"å¼·å£¯çš„",selected:false},
        {word:"arm",meaning:"æ‰‹è‡‚",selected:false},
        {word:"height",meaning:"èº«é«˜ï¼›é«˜åº¦",selected:false},
        {word:"player",meaning:"é¸æ‰‹ï¼›çƒå“¡",selected:false},
        {word:"the USA",meaning:"ç¾åœ‹",selected:false},
        {word:"body",meaning:"èº«é«”",selected:false},
        {word:"put ones all",meaning:"ç›¡å…¨åŠ›",selected:false},
        {word:"into",meaning:"åˆ°â‹¯â‹¯è£¡é¢",selected:false},
        {word:"a lot of",meaning:"å¾ˆå¤šçš„",selected:false},
        {word:"stand out",meaning:"çªå‡º",selected:false},
        {word:"different",meaning:"ä¸åŒçš„",selected:false},
        {word:"top",meaning:"é ‚å°–çš„",selected:false},
        {word:"on the other hand",meaning:"å¦ä¸€æ–¹é¢",selected:false},
        {word:"make up for",meaning:"å½Œè£œâ‹¯â‹¯",selected:false},
        {word:"born",meaning:"å¤©ç”Ÿçš„",selected:false},
        {word:"perfect",meaning:"å®Œç¾çš„",selected:false},
        {word:"three-pointer",meaning:"ä¸‰åˆ†çƒ",selected:false},
        {word:"hard work",meaning:"å‹¤å¥®åŠªåŠ›",selected:false},
        {word:"both",meaning:"å…©è€…ï¼ˆéƒ½ï¼‰",selected:false},
      ]
    },
    {
      id: "default-L2",
      name: "åœ‹ä¸€ä¸‹ L2",
      words: [
        {word:"early",meaning:"æ—©çš„",selected:false},
        {word:"work",meaning:"å·¥ä½œ",selected:false},
        {word:"often",meaning:"ç¶“å¸¸",selected:false},
        {word:"get up",meaning:"èµ·åºŠ",selected:false},
        {word:"usually",meaning:"é€šå¸¸",selected:false},
        {word:"seldom",meaning:"å¾ˆå°‘",selected:false},
        {word:"sometimes",meaning:"æœ‰æ™‚å€™",selected:false},
        {word:"even",meaning:"ç”šè‡³",selected:false},
        {word:"late",meaning:"æ™šçš„",selected:false},
        {word:"do ones homework",meaning:"åšåŠŸèª²",selected:false},
        {word:"hour",meaning:"å°æ™‚",selected:false},
        {word:"always",meaning:"ç¸½æ˜¯",selected:false},
        {word:"tired",meaning:"ç–²ç´¯çš„",selected:false},
        {word:"shower",meaning:"æ·‹æµ´",selected:false},
        {word:"never",meaning:"å¾æœª",selected:false},
        {word:"by the way",meaning:"é †å¸¶ä¸€æ",selected:false},
        {word:"library",meaning:"åœ–æ›¸é¤¨",selected:false},
        {word:"check out",meaning:"å€Ÿï¼ˆæ›¸ï¼‰",selected:false},
        {word:"once",meaning:"ä¸€æ¬¡",selected:false},
        {word:"twice",meaning:"å…©æ¬¡",selected:false},
        {word:"brush one's teeth",meaning:"åˆ·ç‰™",selected:false},
        {word:"face",meaning:"è‡‰",selected:false},
        {word:"breakfast",meaning:"æ—©é¤",selected:false},
        {word:"lunch",meaning:"åˆé¤",selected:false},
        {word:"exercise",meaning:"é‹å‹•",selected:false},
        {word:"computer",meaning:"é›»è…¦",selected:false},
        {word:"minute",meaning:"åˆ†é˜",selected:false},
        {word:"answer",meaning:"å›ç­”ï¼›ç­”æ¡ˆ",selected:false},
        {word:"question",meaning:"å•é¡Œ",selected:false},
        {word:"trouble",meaning:"å›°é›£ï¼›éº¼ç…©",selected:false},
        {word:"life",meaning:"ç”Ÿæ´»ï¼›ç”Ÿå‘½",selected:false},
        {word:"love",meaning:"æ„›",selected:false},
        {word:"real",meaning:"çœŸå¯¦çš„",selected:false},
        {word:"walk",meaning:"é›ï¼ˆå¯µç‰©ï¼‰",selected:false},
        {word:"I cant help it.",meaning:"æˆ‘æ²’è¾¦æ³•ï¼›æˆ‘æ§åˆ¶ä¸äº†",selected:false},
        {word:"then",meaning:"ç„¶å¾Œ",selected:false},
        {word:"too",meaning:"å¤ªâ‹¯â‹¯",selected:false},
        {word:"How often",meaning:"å¤šå¸¸â‹¯â‹¯ï¼Ÿ",selected:false},
        {word:"about",meaning:"å¤§ç´„",selected:false},
        {word:"cram school",meaning:"è£œç¿’ç­",selected:false},
        {word:"owl",meaning:"è²“é ­é·¹",selected:false},
      ]
    }
  ]
};

function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (parsed && Array.isArray(parsed.folders) && parsed.folders.length > 0) return parsed;
    }
  } catch(e) {}
  return JSON.parse(JSON.stringify(DEFAULT_DATA));
}

function saveData() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
}

let data = loadData();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// screen: "home" | "folder" | "quiz" | "end"
let screen = "home";
let activeFolderId = null;

// quiz state
let quizWords   = [];   // the words for current quiz (shuffled)
let quizIdx     = 0;
let revealed    = [];
let userInput   = [];
let wrongLetters= [];
let hintUsed    = false;
let quizStatus  = "playing"; // playing | correct
let score       = { correct:0, wrong:0 };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uid() { return "id-" + Date.now() + "-" + Math.random().toString(36).slice(2,7); }
function shuffle(arr) {
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}
function activeFolder() { return data.folders.find(f => f.id === activeFolderId); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome() {
  let folderCards = data.folders.map(f => {
    const isRenaming = (renamingFolderId === f.id);
    const nameArea = isRenaming
      ? `<input id="rename-input-${f.id}" class="rename-input" type="text" value="${escHtml(f.name)}" autocomplete="off"
          onkeydown="if(event.key==='Enter')confirmRename('${f.id}');if(event.key==='Escape')cancelRename();" />`
      : `<div class="folder-name">${escHtml(f.name)}</div>`;
    const actionsHtml = isRenaming
      ? `<button class="folder-btn ok" onclick="confirmRename('${f.id}')" title="ç¢ºèª">âœ“</button>
         <button class="folder-btn" onclick="cancelRename()" title="å–æ¶ˆ">âœ•</button>`
      : `<button class="folder-btn" onclick="renameFolder('${f.id}')" title="é‡å‘½å">âœï¸</button>
         <button class="folder-btn del" onclick="deleteFolder('${f.id}')" title="åˆªé™¤">ğŸ—‘</button>`;
    return `
      <div class="folder-card ${isRenaming ? 'renaming' : ''}" onclick="${isRenaming ? '' : `openFolder('${f.id}')`}">
        <div class="folder-icon">ğŸ“</div>
        <div class="folder-info">
          ${nameArea}
          <div class="folder-count">${f.words.length} å€‹å–®è©</div>
        </div>
        <div class="folder-actions" onclick="event.stopPropagation()">
          ${actionsHtml}
        </div>
      </div>`;
  }).join("");

  document.getElementById("app").innerHTML = `
    <div class="header"><h1>âœï¸ Spelling Practice</h1></div>
    <div class="add-folder-row">
      <input id="new-folder-input" type="text" placeholder="è¼¸å…¥æ–°è³‡æ–™å¤¾åç¨±â€¦" autocomplete="off"
        onkeydown="if(event.key==='Enter')addFolder()" />
      <button class="btn-add-folder" onclick="addFolder()">ï¼‹ æ–°å¢</button>
    </div>
    <div class="folder-grid">${folderCards}</div>
  `;
}

function addFolder() {
  const input = document.getElementById("new-folder-input");
  const name = input.value.trim();
  if (!name) return;
  data.folders.push({ id: uid(), name: name, words: [] });
  saveData();
  input.value = "";
  renderHome();
  setTimeout(() => document.getElementById("new-folder-input")?.focus(), 40);
}

function deleteFolder(fid) {
  if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è³‡æ–™å¤¾åŠæ‰€æœ‰å–®è©å—ï¼Ÿ")) return;
  data.folders = data.folders.filter(f => f.id !== fid);
  saveData();
  renderHome();
}

// rename state
let renamingFolderId = null;

function renameFolder(fid) {
  renamingFolderId = fid;
  renderHome();
  // focus the input that just got rendered
  setTimeout(() => {
    const el = document.getElementById("rename-input-" + fid);
    if (el) { el.focus(); el.select(); }
  }, 50);
}

function confirmRename(fid) {
  const el = document.getElementById("rename-input-" + fid);
  const val = el ? el.value.trim() : "";
  if (val) {
    const folder = data.folders.find(f => f.id === fid);
    folder.name = val;
    saveData();
  }
  renamingFolderId = null;
  renderHome();
}

function cancelRename() {
  renamingFolderId = null;
  renderHome();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FOLDER / WORD MANAGER SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openFolder(fid) {
  activeFolderId = fid;
  screen = "folder";
  renderFolder();
}

function renderFolder() {
  const folder = activeFolder();
  if (!folder) { screen="home"; renderHome(); return; }

  const selectedCount = folder.words.filter(w => w.selected).length;
  const allSelected = folder.words.length > 0 && selectedCount === folder.words.length;
  const testCount = selectedCount > 0 ? selectedCount : folder.words.length;

  let wordItems = folder.words.map((w, i) => `
    <div class="word-item ${w.selected ? 'selected' : ''}" onclick="toggleSelect('${folder.id}', ${i})">
      <div class="wi-check"></div>
      <div class="wi-text">
        <span class="wi-word">${escHtml(w.word)}</span>
        <span class="wi-meaning">${escHtml(w.meaning)}</span>
      </div>
      <button class="wi-del" onclick="event.stopPropagation(); deleteWord('${folder.id}', ${i})">ğŸ—‘</button>
    </div>
  `).join("");

  document.getElementById("app").innerHTML = `
    <div class="header">
      <button class="header-back" onclick="goHome()">â† è¿”å›</button>
      <h1>${escHtml(folder.name)}</h1>
    </div>
    <div class="wm-add-row">
      <input id="wm-word"    type="text" placeholder="è‹±æ–‡å–®è©" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" onkeydown="if(event.key==='Enter')addWord()" />
      <input id="wm-meaning" type="text" placeholder="ä¸­æ–‡æ„æ€" autocomplete="off" onkeydown="if(event.key==='Enter')addWord()" />
      <button class="btn-add-word" onclick="addWord()">ï¼‹</button>
    </div>
    ${folder.words.length > 0 ? `
      <div class="select-all-row" onclick="toggleAll('${folder.id}')">
        <div class="wi-check" style="width:20px;height:20px;border-radius:5px;border:2px solid ${allSelected ? 'var(--blue)' : 'var(--border-mid)'};background:${allSelected ? 'var(--blue)' : 'transparent'};display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          ${allSelected ? '<svg width="10" height="14" viewBox="0 0 10 14"><path d="M1 7l3 4 5-7" stroke="#fff" stroke-width="2.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>' : ''}
        </div>
        <span>å…¨é¸ / å–æ¶ˆå…¨é¸</span>
      </div>
    ` : ''}
    <div class="word-list">${wordItems}</div>
    <div class="wm-footer">
      <span class="wm-selected-info">
        å°‡æ¸¬è©¦ï¼š<span>${testCount}</span> å€‹å–®è©
        ${selectedCount > 0 ? `ï¼ˆå·²å‹¾é¸ ${selectedCount}ï¼‰` : 'ï¼ˆæœªå‹¾é¸ï¼Œæ¸¬è©¦å…¨éƒ¨ï¼‰'}
      </span>
      <button class="btn-start-test" ${folder.words.length === 0 ? 'disabled' : ''} onclick="startQuiz('${folder.id}')">é–‹å§‹æ¸¬è©¦ â†’</button>
    </div>
  `;
  setTimeout(() => document.getElementById("wm-word")?.focus(), 50);
}

function addWord() {
  const folder = activeFolder();
  const wInput  = document.getElementById("wm-word");
  const mInput  = document.getElementById("wm-meaning");
  const w = wInput.value.trim().toLowerCase();
  const m = mInput.value.trim();
  if (w && m && !folder.words.find(x => x.word === w)) {
    folder.words.push({ word: w, meaning: m, selected: false });
    saveData();
    wInput.value = "";
    mInput.value = "";
    renderFolder();
    setTimeout(() => document.getElementById("wm-word")?.focus(), 40);
  }
}

function deleteWord(fid, idx) {
  const folder = data.folders.find(f => f.id === fid);
  folder.words.splice(idx, 1);
  saveData();
  renderFolder();
}

function toggleSelect(fid, idx) {
  const folder = data.folders.find(f => f.id === fid);
  folder.words[idx].selected = !folder.words[idx].selected;
  saveData();
  renderFolder();
}

function toggleAll(fid) {
  const folder = data.folders.find(f => f.id === fid);
  const allSelected = folder.words.every(w => w.selected);
  folder.words.forEach(w => w.selected = !allSelected);
  saveData();
  renderFolder();
}

function goHome() { screen="home"; renderHome(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startQuiz(fid) {
  const folder = data.folders.find(f => f.id === fid);
  const selected = folder.words.filter(w => w.selected);
  quizWords = shuffle(selected.length > 0 ? selected : folder.words);
  quizIdx   = 0;
  score     = { correct:0, wrong:0 };
  screen    = "quiz";
  initQuizRound();
}

function initQuizRound() {
  const w = quizWords[quizIdx].word;
  // Auto-reveal: first character + every space
  revealed = [];
  for (let i = 0; i < w.length; i++) {
    if (i === 0 || w[i] === " ") revealed.push(i);
  }
  userInput    = Array(w.length).fill("");
  wrongLetters = [];
  hintUsed     = false;
  quizStatus   = "playing";
  renderQuiz();
}

function getActiveSlot() {
  const w = quizWords[quizIdx].word;
  for (let i=0; i<w.length; i++) { if (!revealed.includes(i) && !userInput[i]) return i; }
  return -1;
}

function handleLetter(key) {
  if (quizStatus !== "playing") return;
  const w = quizWords[quizIdx].word;
  const slot = getActiveSlot();
  if (slot === -1) return;
  userInput[slot] = key;
  if (w[slot] === key) {
    const allFilled = userInput.every((v,i) => revealed.includes(i) || v !== "");
    if (allFilled) { quizStatus="correct"; score.correct++; fireConfetti(); }
  } else {
    wrongLetters.push(slot);
    if (wrongLetters.length >= 3) { revealed.push(slot); userInput[slot]=""; wrongLetters=[]; }
  }
  renderQuiz();
}

function handleBackspace() {
  if (quizStatus !== "playing") return;
  for (let i=userInput.length-1; i>=0; i--) {
    if (!revealed.includes(i) && userInput[i]) { userInput[i]=""; break; }
  }
  renderQuiz();
}

function giveHint() {
  if (hintUsed || quizStatus !== "playing") return;
  const w = quizWords[quizIdx].word;
  for (let i=0; i<w.length; i++) { if (!revealed.includes(i)) { revealed.push(i); hintUsed=true; break; } }
  renderQuiz();
}

function skipWord() { score.wrong++; goNextQuiz(); }

function goNextQuiz() {
  if (quizIdx+1 >= quizWords.length) { screen="end"; renderEnd(); }
  else { quizIdx++; initQuizRound(); }
}

function renderQuiz() {
  const entry = quizWords[quizIdx];
  const word  = entry.word;
  const progress = (quizIdx / quizWords.length) * 100;

  let lettersHtml = "";
  for (let i=0; i<word.length; i++) {
    // Space characters â†’ narrow visual gap
    if (word[i] === " ") {
      lettersHtml += `<div class="letter-box space"></div>`;
      continue;
    }
    const isRevealed = revealed.includes(i);
    const hasUser    = !!userInput[i];
    const isWrong    = wrongLetters.includes(i);
    let cls = "letter-box";
    if      (isRevealed) cls += " revealed";
    else if (hasUser)    cls += " filled";
    else if (isWrong)    cls += " wrong";
    const display  = isRevealed ? word[i] : (userInput[i] || "");
    const underline = (!isRevealed && !hasUser) ? '<div class="underline"></div>' : "";
    lettersHtml += `<div class="${cls}"><span>${display}</span>${underline}</div>`;
  }

  let statusHtml = "";
  if (quizStatus === "correct") statusHtml = `<div class="msg msg-correct">ğŸ‰ æ­£ç¢ºï¼å–®è©æ˜¯ "${word}"</div>`;
  else if (wrongLetters.length > 0) statusHtml = `<div class="msg msg-warning">âš ï¸ éŒ¯èª¤ ${wrongLetters.length}/3 æ¬¡å¾Œå°‡è‡ªå‹•æ­éœ²è©²å­—æ¯</div>`;

  let btnsHtml = "";
  if (quizStatus === "playing") btnsHtml = `
    <button class="btn btn-hint" ${hintUsed?'disabled':''} onclick="giveHint()">ğŸ’¡ æç¤º</button>
    <button class="btn btn-skip" onclick="skipWord()">â­ è·³é</button>`;
  else btnsHtml = `<button class="btn btn-next" onclick="goNextQuiz()">ä¸‹ä¸€é¡Œ â†’</button>`;

  // virtual keyboard
  const rows=[["q","w","e","r","t","y","u","i","o","p"],["a","s","d","f","g","h","j","k","l"],["z","x","c","v","b","n","m","âŒ«"]];
  let vkbHtml = '<div class="vkb">';
  rows.forEach(row => {
    vkbHtml += '<div class="vkb-row">';
    row.forEach(k => {
      if (k==="âŒ«") vkbHtml += `<div class="vkb-key backspace" onclick="handleBackspace();renderQuiz();">âŒ«</div>`;
      else         vkbHtml += `<div class="vkb-key" onclick="handleLetter('${k}')">${k}</div>`;
    });
    vkbHtml += '</div>';
  });
  if (word.includes(" ")) {
    vkbHtml += `<div class="vkb-row"><div class="vkb-key vkb-space" onclick="handleLetter(' ')">SPACE</div></div>`;
  }
  vkbHtml += '</div>';

  document.getElementById("app").innerHTML = `
    <div class="header">
      <button class="header-back" onclick="goHome()">â† è¿”å›</button>
      <h1>${escHtml(activeFolder()?.name || "")}</h1>
    </div>
    <div class="progress-header">
      <span>ç¬¬ ${quizIdx+1} / ${quizWords.length} é¡Œ</span>
      <span>âœ… ${score.correct} &nbsp; âŒ ${score.wrong}</span>
    </div>
    <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${progress}%"></div></div>
    <div class="card">
      <div class="meaning-badge">${escHtml(entry.meaning)}</div>
      <div class="letters-row">${lettersHtml}</div>
      ${statusHtml}
      <div class="btn-row">${btnsHtml}</div>
      ${vkbHtml}
    </div>
    <div class="instructions"><p>é›»è…¦ï¼šç›´æ¥ç”¨éµç›¤è¼¸å…¥å­—æ¯<br>æ‰‹æ©Ÿï¼šä½¿ç”¨ä¸‹æ–¹è™›æ“¬éµç›¤<br>éŒ¯èª¤ 3 æ¬¡å¾Œè‡ªå‹•æ­éœ²è©²ä½ç½®</p></div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEnd() {
  const total = score.correct + score.wrong;
  const pct   = Math.round((score.correct / total) * 100);
  const emoji = pct >= 70 ? "ğŸ‰" : pct >= 40 ? "ğŸ‘" : "ğŸ“š";
  document.getElementById("app").innerHTML = `
    <div class="end-screen">
      <div class="end-emoji">${emoji}</div>
      <h2>æ¸¬è©¦å®Œæˆï¼</h2>
      <p style="color:var(--text-sub);margin-bottom:4px;">æ­£ç¢ºç‡</p>
      <p class="end-pct">${pct}%</p>
      <div class="end-stats">
        <div><div class="end-stat-val" style="color:var(--green)">${score.correct}</div><div class="end-stat-label">æ­£ç¢º</div></div>
        <div><div class="end-stat-val" style="color:var(--red)">${score.wrong}</div><div class="end-stat-label">éŒ¯èª¤/è·³é</div></div>
      </div>
      <div class="end-btn-row">
        <button class="btn-restart" onclick="startQuiz('${activeFolderId}')">å†ä¾†ä¸€è¼ª</button>
        <button class="btn-back-home" onclick="goHome()">â† å›é¦–é </button>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFETTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fireConfetti() {
  const c = document.getElementById("confetti");
  c.innerHTML = "";
  const colors=["#f59e0b","#10b981","#3b82f6","#ef4444","#8b5cf6","#ec4899"];
  for (let i=0; i<44; i++) {
    const el = document.createElement("div");
    el.className = "confetti-piece";
    const size = 6 + Math.random()*9;
    el.style.left  = (Math.random()*100)+"%";
    el.style.width = size+"px"; el.style.height = size+"px";
    el.style.background = colors[i%colors.length];
    el.style.borderRadius = (i%3===0)?"50%":"2px";
    el.style.animationDelay = (Math.random()*0.3)+"s";
    c.appendChild(el);
  }
  setTimeout(() => { c.innerHTML=""; }, 2400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener("keydown", (e) => {
  if (screen !== "quiz") return;
  const key = e.key.toLowerCase();
  if (/^[a-z]$/.test(key)) { e.preventDefault(); handleLetter(key); }
  if (e.key === " ") { e.preventDefault(); handleLetter(" "); }
  if (e.key === "Backspace") { e.preventDefault(); handleBackspace(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s) { return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderHome();
</script>
</body>
</html>
